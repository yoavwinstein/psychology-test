<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no" />
    <title>מטלה קוגנטיבית</title>


    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://bootswatch.com/4/cyborg/bootstrap.min.css">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <link rel="stylesheet" type="text/css" href="style.css" />

    <script>
        var NUMBER_OF_ANSWERS = {
            true: 16, // testMode = true
            false: 60 // testMode = false
        };

        var currentUserStage = 1;
        var numberOfIterations = 0;
        var currentStage = 0;
        var expectedArrow = null;
        var userFirstArrow = undefined;
        var userFirstArrowTime = undefined;
        var currentVocalLetter = null;
        var stage4BeginTime;
        var levelOrder = [1, 2, 3];
        var currentLevel = 0;
        var userData = []
        var testMode = true;

        function shuffle(array) {
            array.sort(() => Math.random() - 0.5);
        }

        shuffle(levelOrder);

        function playSound(soundName) {
            var elem = document.getElementById("play_" + soundName);
            elem.play();
        }

        function showElem(elemName, shouldShow) {
            var elem = document.getElementById(elemName);
            elem.style.display = shouldShow ? "inherit" : "none";
        }

        function performStage1() {
            currentStage = 1;
            showElem("test_description", false);
            showElem("test_level_checkpoint", false);
            showElem("test_phase1", true);
            setTimeout(function () {
                performStage2();
            }, 500);
        }

        function performStage2() {
            currentStage = 2;
            showElem("test_phase1", false);
            setTimeout(function () {
                performStage3();
            }, 500);

            // For now playing 100ms beforehand
            setTimeout(function () {
                currentVocalLetter = randomVocalLetter();
                playSound(currentVocalLetter);
            }, 400);
        }

        function replaceAtIndex(str, index, replacement) {
            return str.substr(0, index) + replacement + str.substr(index + replacement.length);
        }

        function randomLetter() {
            var firstLetter = "א".charCodeAt(0);
            var idx = Math.floor(Math.random() * 4);
            return String.fromCharCode(firstLetter + idx);
        }

        function randomFromList(items) {
            return items[Math.floor(Math.random() * items.length)];
        }

        function randomCorrectHebrewLetter() {
            var letters = ["ב", "ח", "ה", "פ"];
            return randomFromList(letters);
        }

        function randomVocalLetter() {
            var letters = ["ב", "ח", "ה", "פ", "ו"];
            return randomFromList(letters);
        }

        function generateStage3Text() {

            var index = Math.floor(Math.random() * 6);

            var letters = [
                "א", "ג", "ע", "צ", "ר"
            ];

            shuffle(letters);

            for (var i = 0; i < 6; ++i) {
                var elem = document.getElementById("idx_" + i);

                if (i === index) {
                    elem.style.color = "inherit";
                    var letter = randomCorrectHebrewLetter();
                    if (letter === "ב" || letter === "ח") {
                        expectedArrow = "ArrowRight";
                    } else if (letter === "ה" || letter === "פ") {
                        expectedArrow = "ArrowLeft";
                    }
                    elem.innerText = letter;
                } else {
                    if (currentLevel == 1) {
                        elem.innerText = ".";
                        elem.style.color = "inherit";
                    } else if (currentLevel == 2) {
                        elem.innerText = letters.pop();
                        elem.style.color = "red";
                    } else if (currentLevel == 3) {
                        elem.innerText = letters.pop();
                        elem.style.color = "inherit";
                    }
                }
            }
        }

        function performStage3() {
            userFirstArrow = undefined;
            userFirstArrowTime = undefined;
            currentStage = 3;
            generateStage3Text();
            showElem("test_phase3", true);
            setTimeout(function () {
                performStage4();
            }, 120);
        }

        function levelNumberToName() {
            return {
                1: 'Low Load',
                2: 'Dilution',
                3: 'High Load'
            }[currentLevel];
        }

        function translateArrowName(arrow) {
            if (arrow === "ArrowLeft") {
                return "שמאל";
            } else if (arrow === "ArrowRight") {
                return "ימין";
            }
            return "באג";
        }

        function collectDataFromStage3() {
            var delayMS = null;
            if (userFirstArrowTime) {
                delayMS = userFirstArrowTime - stage4BeginTime;
            }

            selectedArrow = userFirstArrow ? userFirstArrow : null

            userData.push({
                delayMS,
                isCorrect: expectedArrow === selectedArrow ? "נכון" : "טעות",
                currentVocalLetter,
                level: levelNumberToName(),
                isTest: testMode ? "אימון" : "מבחן",
                expectedArrow: translateArrowName(expectedArrow),
                selectedArrow: translateArrowName(selectedArrow),
            });
        }

        function performStage4() {
            currentStage = 4;

            stage4BeginTime = performance.now();

            showElem("test_phase3", false);
        }

        function endTest() {
            showCursor(true);
            showElem("test_done", true);
            closeFullscreen();
        }

        function showLevelDescription() {
            showCursor(true);
            showElem("test_description", true);
            var elem = document.getElementById("test_button_begin_level");
            if (testMode) {
                elem.innerText = "להתחלת שלב האימון";
            } else {
                elem.innerText = "להתחלת שלב המטלה";
            }

            var titleElem = document.getElementById("test_description_title");
            titleElem.innerText = testMode ? "אימון" : "מטלה";
        }

        function onBeginTest() {
            openFullscreen();

            showElem("test", true);
            showElem("begintestbutton", false);

            currentLevel = levelOrder.pop();

            showLevelDescription();
        }

        var docElem = document.documentElement;
        function openFullscreen() {
            if (docElem.requestFullscreen) {
                docElem.requestFullscreen();
            } else if (docElem.mozRequestFullScreen) { /* Firefox */
                docElem.mozRequestFullScreen();
            } else if (docElem.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
                docElem.webkitRequestFullscreen();
            } else if (docElem.msRequestFullscreen) { /* IE/Edge */
                docElem.msRequestFullscreen();
            }
        }

        function closeFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.mozCancelFullScreen) { /* Firefox */
                document.mozCancelFullScreen();
            } else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { /* IE/Edge */
                document.msExitFullscreen();
            }
        }

        function showLevelCheckpoint() {

            showCursor(true);
            showElem("test_level_checkpoint", true);

            var elem = document.getElementById("test_button_begin_next_level");
            var checkpointDescription = document.getElementById("test_level_checkpoint_description");
            if (testMode) {
                elem.innerText = "להתחלת שלב המטלה של שלב " + currentUserStage;
                checkpointDescription.innerText = "סיימת את שלב האימון של שלב " + currentUserStage;
            } else {
                elem.innerText = "להתחלת שלב האימון של שלב " + (currentUserStage + 1);
                checkpointDescription.innerText = "סיימת את שלב המטלה של שלב " + currentUserStage;
            }
        }

        function advanceLevel() {
            numberOfIterations = 0;
            if (!testMode) {
                currentLevel = levelOrder.pop();
            }
            uploadTestData();
            if (!currentLevel) {
                endTest();
            } else {
                showLevelCheckpoint();
            }
            testMode = !testMode;
        }

        function beginTestCountdown() {
            var i = 10;
            var countdownText = document.getElementById("test_countdown");
            showElem("test_description", false);
            showElem("test_level_checkpoint", false);
            showElem("test_phase1", true);
            showElem("test_countdown_container", true);
            countdownText.innerText = i;
            var interval = setInterval(function () {

                i--;
                countdownText.innerText = i;
                if (i == 0) {
                    showElem("test_countdown_container", false);
                    clearInterval(interval);
                    performStage1();
                }
            }, 1000);
        }

        function onKeyDown(event) {
            if (currentStage == 4) {
                if (event.key === "ArrowLeft" || event.key === "ArrowRight") {
                    if (!userFirstArrow) {
                        userFirstArrowTime = performance.now();
                        userFirstArrow = event.key;

                        if (testMode) {
                            if (userFirstArrow === expectedArrow) {
                                playSound("success");
                            } else {
                                playSound("failure");
                            }
                        }

                        setTimeout(function () {
                            numberOfIterations++;
                            collectDataFromStage3();
                            if (numberOfIterations < NUMBER_OF_ANSWERS[testMode]) {
                                performStage1();
                            } else {
                                advanceLevel();
                            }
                        }, 500);
                    }
                }
            }
        }

        function showCursor(show) {
            var body = document.getElementById("body");
            body.style.cursor = show ? "inherit" : "none";
        }

        function onBeginLevel() {
            showCursor(false);
            if (!testMode) {
                currentUserStage++;
            }
            beginTestCountdown();
        }

        function uploadTestData() {
            var xhr = new XMLHttpRequest();
            var url = "../post";
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    console.log("Upload successful");
                }
            };
            var data = JSON.stringify(userData);
            xhr.send(data);
        }

        function bodyLoad() {
            document.getElementById("play_success").playbackRate = 1.5;
        }

    </script>

</head>

<body onload="bodyLoad()" onkeydown="onKeyDown(event)" id="body">
    <div id="test" style="display: none;
    vertical-align: middle;">

        <div id="test_phase1" class="centered" style="display: none">
            <h1>+</h1>
        </div>

        <!-- phase2 is pitch black, so just hiding both -->

        <div id="test_countdown_container" style="display: none">
            המבחן יתחיל בעוד <span id="test_countdown">10</span> שניות. <br />
            נא להתמקד בפלוס שלמטה
        </div>

        <div id="test_phase3" class="centered" style="display: none">
            <table align="center" style="text-align: center; vertical-align: middle">
                <tr>
                    <td><h1 id="idx_0"></h1></td>
                    <td><h1 id="idx_1"></h1></td>
                    <td><h1 id="idx_2"></h1></td>
                    <td><h1 id="idx_3"></h1></td>
                    <td><h1 id="idx_4"></h1></td>
                    <td><h1 id="idx_5"></h1></td>
                </tr>
            </table>
        </div>

        <div id="test_description">
            <h1>שלב <span id="test_description_title"></span></h1>
            <h2>יש להקיש על מקש החץ הימני אם הופיעה האות ב' או ח'.</h2>
            <h2>יש להקיש על מקש החץ השמאלי אם הופיעה האות ה' או פ'.</h2>
            כך תישמע תשובה נכונה <audio controls id="play_success">
                <source src="audio/success.mp3" />
            </audio> <br />
            כך תישמע תשובה שגויה <audio controls id="play_failure">
                <source src="audio/failure.mp3" />
            </audio> <br />
            <button type="button" class="btn btn-primary" onclick="onBeginLevel()" id="test_button_begin_level">התחל שלב</button>
        </div>

        <div id="test_level_checkpoint" style="display: none">
            <h2 id="test_level_checkpoint_description">סיימת שלב</h2>
            <h2>יש להקיש על מקש החץ הימני אם הופיעה האות ב' או ח'.</h2>
            <h2>יש להקיש על מקש החץ השמאלי אם הופיעה האות ה' או פ'.</h2>
            <button type="button" class="btn btn-primary" onclick="onBeginLevel()" id="test_button_begin_next_level">התחל שלב</button>
        </div>

        <div id="test_done" style="display: none">
            <h1><pre>המטלה הסתיימה.
אנו מודים לך מקרב לב על השתתפותך בניסוי.
עדי דוידוב ואורי וינשטיין

האתר פותח ע"י <a href="https://github.com/yoavwinstein">יואב וינשטיין</a></pre></h1>
        </div>
    </div>

    <div id="begintestbutton">
        <pre>משתתף/ת יקר/ה,
נא וודא/י כי האוזניות מחוברות, והרכב/הרכיבי אותן בהתאם לסימול המתאים: אוזן ימין - R, אוזן שמאל - L.
במטלה הנוכחית יש להניח את היד על מקשי החצים במקלדת.
בכל שלב במטלה, תופיע אות / מספר אותיות על גבי צג המחשב למשך זמן קצר.
יש להקיש על מקש החץ הימני אם הופיעה האות ב' או ח'.
יש להקיש על מקש החץ השמאלי אם הופיעה האות ה' או פ'.
למטלה 3 חלקים.
לפני תחילת כל חלק, תתנסה/י בשלב מקדים של אימון.
יש להקיש על המקש הנכון מהר ככל האפשר.
השתדל/י לבצע את המטלה ללא הסחות דעת ובסביבה שקטה.
לחץ/י על כפתור המשך על מנת להתקדם לשלב האימון.
</pre>
        <button type="button" class="btn btn-primary" onclick="onBeginTest()">להתחלת המענה</button>
    </div>

    <audio hidden="hidden" id="play_ב">
        <source src="audio/ב.mp3" />
    </audio>
    <audio hidden="hidden" id="play_ח">
        <source src="audio/ח.mp3" />
    </audio>
    <audio hidden="hidden" id="play_פ">
        <source src="audio/פ.mp3" />
    </audio>
    <audio hidden="hidden" id="play_ה">
        <source src="audio/ה.mp3" />
    </audio>
    <audio hidden="hidden" id="play_ו">
        <source src="audio/ו.mp3" />
    </audio>
</body>
</html>
