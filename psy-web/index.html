<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no" />
    <title>מבחן מגניב</title>

    <link rel="stylesheet" type="text/css" href="style.css" />

    <script>
        var numberOfIterations = 0;
        var currentStage = 0;
        var expectedArrow = null;
        var userFirstArrow = undefined;
        var userFirstArrowTime = undefined;
        var stage4BeginTime;
        var levelOrder = [1, 2, 3];
        var currentLevel = 0;
        var userData = []
        var testMode = true;

        function shuffle(array) {
            array.sort(() => Math.random() - 0.5);
        }

        shuffle(levelOrder);

        function playSound(soundName) {
            var elem = document.getElementById("play_" + soundName);
            elem.play();
        }

        function showElem(elemName, shouldShow) {
            var elem = document.getElementById(elemName);
            elem.style.display = shouldShow ? "inherit" : "none";
        }

        function performStage1() {
            currentStage = 1;
            showElem("test_description", false);
            showElem("test_phase1", true);
            setTimeout(function () {
                performStage2();
            }, 500);
        }

        function performStage2() {
            currentStage = 2;
            showElem("test_phase1", false);
            setTimeout(function () {
                performStage3();
            }, 500);

            // For now playing 100ms beforehand
            setTimeout(function () {
                playSound(randomLetterEnglish());
            }, 400);
        }

        function replaceAtIndex(str, index, replacement) {
            return str.substr(0, index) + replacement + str.substr(index + replacement.length);
        }

        function randomLetter() {
            var firstLetter = "א".charCodeAt(0);
            var idx = Math.floor(Math.random() * 4);
            return String.fromCharCode(firstLetter + idx);
        }

        function randomFromList(items) {
            return items[Math.floor(Math.random() * items.length)];
        }

        function randomCorrectHebrewLetter() {
            var letters = ["ב", "ח", "ה", "פ"];
            return randomFromList(letters);
        }

        function randomIncorrectHebrewLetter() {
            var letters = [
                "א", "ג", "ד", "ו", "ז", "ט", "י", "כ", "ל", "מ",
                "נ", "ס", "ע", "צ", "ק", "ר", "ש", "ת"
            ];
            return randomFromList(letters);
        }

        function randomLetterEnglish() {
            var firstLetter = "a".charCodeAt(0);
            var idx = Math.floor(Math.random() * 4);
            return String.fromCharCode(firstLetter + idx);
        }

        function generateStage3Text() {

            var index = Math.floor(Math.random() * 6);

            for (var i = 0; i < 6; ++i) {
                var elem = document.getElementById("idx_" + i);
                if (currentLevel == 1) {
                    elem.innerText = ".";
                    elem.style.color = "inherit";
                } else if (currentLevel == 2) {
                    elem.innerText = randomIncorrectHebrewLetter();
                    elem.style.color = "red";
                } else {
                    elem.innerText = randomIncorrectHebrewLetter();
                    elem.style.color = "inherit";
                }
                if (i === index) {
                    elem.style.color = "inherit";
                    var letter = randomCorrectHebrewLetter();
                    if (letter === "ב" || letter === "ח") {
                        expectedArrow = "ArrowRight";
                    } else if (letter === "ה" || letter === "פ") {
                        expectedArrow = "ArrowLeft";
                    }
                    elem.innerText = letter;
                }
            }
        }

        function performStage3() {
            userFirstArrow = undefined;
            userFirstArrowTime = undefined;
            currentStage = 3;
            generateStage3Text();
            showElem("test_phase3", true);
            setTimeout(function () {
                performStage4();
            }, 120);
        }

        function levelNumberToName() {
            return {
                1: 'Low Load',
                2: 'Dilution',
                3: 'High Load'
            }[currentLevel];
        }

        function collectDataFromStage3() {
            var delayMS = null;
            if (userFirstArrowTime) {
                delayMS = userFirstArrowTime - stage4BeginTime;
            }

            selectedArrow = userFirstArrow ? userFirstArrow : null

            userData.push({
                delayMS: delayMS,
                expectedArrow: expectedArrow,
                selectedArrow: selectedArrow,
                level: levelNumberToName(),
                isTest: testMode ? "true" : "false"
            });
        }

        function performStage4() {
            currentStage = 4;

            stage4BeginTime = performance.now();

            showElem("test_phase3", false);
        }

        function endTest() {
            showElem("test_done", true);
            closeFullscreen();
        }

        function showLevelDescription() {
            
            showElem("test_description", true);
            showElem("test_description_1", false);
            showElem("test_description_2", false);
            showElem("test_description_3", false);
            showElem("test_description_" + currentLevel, true);
        }

        function onBeginTest() {
            openFullscreen();
        
            showElem("test", true);
            showElem("begintestbutton", false);

            currentLevel = levelOrder.pop();

            showLevelDescription();
        }

        var docElem = document.documentElement;
        function openFullscreen() {
            if (docElem.requestFullscreen) {
                docElem.requestFullscreen();
            } else if (docElem.mozRequestFullScreen) { /* Firefox */
                docElem.mozRequestFullScreen();
            } else if (docElem.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
                docElem.webkitRequestFullscreen();
            } else if (docElem.msRequestFullscreen) { /* IE/Edge */
                docElem.msRequestFullscreen();
            }
        }

        function closeFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.mozCancelFullScreen) { /* Firefox */
                document.mozCancelFullScreen();
            } else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { /* IE/Edge */
                document.msExitFullscreen();
            }
        }

        function advanceLevel() {
            numberOfIterations = 0;
            if (!testMode) {
                currentLevel = levelOrder.pop();
            }
            testMode = !testMode;
            uploadTestData();
            if (!currentLevel) {
                endTest();
            } else {
                showLevelDescription();
            }
        }

        function onKeyDown(event) {
            if (currentStage == 4) {
                if (event.key === "ArrowLeft" || event.key === "ArrowRight") {
                    if (!userFirstArrow) {
                        userFirstArrowTime = performance.now();
                        userFirstArrow = event.key;

                        if (testMode) {
                            if (userFirstArrow === expectedArrow) {
                                playSound("success");
                            } else {
                                playSound("failure");
                            }
                        }

                        setTimeout(function () {
                            numberOfIterations++;
                            collectDataFromStage3();
                            if (numberOfIterations < 3) {
                                performStage1();
                            } else {
                                advanceLevel();
                            }
                        }, 500);
                    }
                }
            }
        }

        function onBeginLevel() {
            performStage1();
        }

        function uploadTestData() {
            var xhr = new XMLHttpRequest();
            var url = "http://localhost:3232/post";
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    // data was uploaded successfully
                    // var json = JSON.parse(xhr.responseText);
                    // console.log(json.email + ", " + json.password);
                    console.log("Upload successful");
                }
            };
            var data = JSON.stringify(userData);
            xhr.send(data);
        }

    </script>

</head>

<body onkeydown="onKeyDown(event)">
    <div id="test" style="display: none;
    vertical-align: middle;">
        <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br />

        <div id="test_phase1" style="display: none">
            <br />
            <h1>+</h1>
        </div>

        <!-- phase2 is pitch black, so just hiding both -->

        <div id="test_phase3" style="display: none">
            <table cellpadding="50" align="center" style="text-align: center">
                <tr>
                    <td><h1 id="idx_0"></h1></td>
                    <td><h1 id="idx_1"></h1></td>
                    <td><h1 id="idx_2"></h1></td>
                    <td><h1 id="idx_3"></h1></td>
                    <td><h1 id="idx_4"></h1></td>
                    <td><h1 id="idx_5"></h1></td>
                </tr>
            </table>
        </div>

        <div id="test_description">
            <h1>טקסט הוראות על בחינה</h1>
            <h2 id="test_description_1">אתה בשלב 1</h2>
            <h2 id="test_description_2">אתה בשלב 2</h2>
            <h2 id="test_description_3">אתה בשלב 3</h2>
            <button onclick="onBeginLevel()">התחל שלב</button>
        </div>

        <div id="test_done" style="display: none">
            <h1>המבחן נגמר. תודה!</h1>
        </div>
    </div>

    <div id="begintestbutton">
        <button onclick="onBeginTest()">התחל מבחן</button>
    </div>

    <audio hidden="hidden" id="play_success">
        <source src="audio/success.mp3" />
    </audio>
    <audio hidden="hidden" id="play_failure">
        <source src="audio/failure.mp3" />
    </audio>

    <audio hidden="hidden" id="play_a">
        <source src="audio/a.mp3" />
    </audio>
    <audio hidden="hidden" id="play_b">
        <source src="audio/b.mp3" />
    </audio>
    <audio hidden="hidden" id="play_c">
        <source src="audio/c.mp3" />
    </audio>
    <audio hidden="hidden" id="play_d">
        <source src="audio/d.mp3" />
    </audio>
</body>
</html>
